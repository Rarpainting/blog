# Golang

## go runtime

### go 线程实现模型

| 中文名称              | 源码中的名称          | 作用域     | 需要说明                             |
| :--:                  | :--:                  | :--:       | :--:                                 |
| 全局 M 列表           | runtime.allm          | 运行时系统 | 能用于存放所有 M 的列表              |
| 全局 P 列表           | runtime.allp          | 运行时系统 | 能用于存放所有 P 的列表              |
| 全局 G 列表           | runtime.allg          | 运行时系统 | 能用于存放所有 G 的列表              |
| 调度器的空闲 M 列表   | runtime ' sched.midle | 调度器     | 被用于存放空闲 M 的列表              |
| 调度器的空闲 P 列表   | runtime ' sched.pidle | 调度器     | 被用于存放空闲 P 的列表              |
| 调度器的可运行 G 队列 | runtime ' sched.runq  | 调度器     | 被用于存放可运行 G 的队列            |
| 调度器的的自由 G 队列 | runtime ' sched.gfree | 调度器     | 被用于存放自由 G 的列表              |
| P 的可运行 G 队列     | runq                  | 本地 P     | 被用于存放当前 P 中的可运行 G 的队列 |
| P 的自由 G 列表       | gfree                 | 本地 P     | 被用于存放当前 P 中的自由 G 的列表   |

### 调度器字段

| 字段名称   | 数据类型 | 用途描述                                                 |
| gcwaiting  | uint32   | 作为垃圾回收任务被执行期间的辅助标记, 停止计数和通知机制 |
| stopwait   | int32    |                                                          |
| stopnote   | Note     |                                                          |
| sysmonwait | uint32   | 作为系统检测任务被执行期间的停止计数和通知机制           |
| sysmonnote | Note     |                                                          |

## Happens Before

**应该以通信作为手段来共享内存**

如果要让一个对变量 v 的写操作 w 所产生的结果能够被对该变量的读操作 r 观察到, 那么需要同时满足如下两个条件

- 读操作 r 未先于写操作 w 发生

- 没有其他对此变量的写操作后于写操作 w 且 先于读操作 r 发生

即在一轮读写操作中 其他写操作 / 本次写操作 w / 本次读操作 r
顺序:

其他写操作 -> 本次写操作 w -> 本次读操作 r

### Go Channel

```golang
var ch chan int // 未初始化
ch <- 0 // 已初始化

ch := make(chan int[, N]) // 已初始化
```

- 从未被初始化的 channel 接受值, 会导致当前 Goroutine 永久阻塞

### Channel's Happens Before

如果一个通道是带缓冲: -- 异步操作

- 针对此通道的发送操作会被阻塞, 直到被发送的元素值**完全复制**到通道的缓冲区

- 针对此通道的接受操作也会被阻塞, 直到当前 Gorountine 真正从中**获取**到一个元素值

- 因此, 对于同一个元素值来说, 把他**发送**给某个通道的操作一定会在从该通道**接收**他的操作完成**之前**完成

如果一个通道是无缓冲的: -- 同步操作

- 向此通道发送元素值的操作会被阻塞, 直到至少有一个针对该通道的接收操作**开始进行**为止

- 从类通道接收元素值的操作会被阻塞, 直到至少有一个针对该通道的发送操作**开始进行**为止

- 针对非缓冲通道的**接收操作**会在与之相对的**发送操作**完成**之前**完成 ---> 发送操作会在明确有对应的接收操作, 且所发送的元素完成发送后才结束操作

### Channel 特性

- **select** 操作是随机的
