# Paxos

## 数据一致性

对于一致性, 从服务端和客户端看

能分为 **内部一致性** 和 **外部一致性**

内部一致性需要全局时钟的支持, 因此一般讨论的是外部一致性

## 两阶段提交(Tow Phase)

### 请求阶段(Commit Request)

在请求阶段, 协调者将通知事务**参与者**准备或提交事务, 然后进入表决过程

在表决阶段, 参与者将告知**协调者**, 自己的决策: 同意(执行成功) **OR** 取消(执行失败)

### 提交阶段(Commit)

协调者通过前一阶段的结果进行决策: 提交或取消

当且仅当 **所有** 的参与者同意提交事务, 协调者才通知所有参与者提交事务, 否则协调者将通知所有的参与者取消事务. 参与者再接收到协调者的消息后将执行响应的操作

不足:
- 同步阻塞: 执行过程中, 所有参与者都是**事务独占**状态, 当参与者占用公共资源时, 第三方节点对公共资源的访问被阻塞
- 单点问题: 一旦协调者发生故障, 参与者会一直阻塞
- 数据不一致性: 在提交阶段, 若接收决策的只有部分参与者, 而其余则没有收到通知而阻塞或超时导致提交失败, 这段时间就产生数据的不一致性

## 三阶段提交

相对两阶段提交, 改进:
- 在协调者和参与者中都引入超时机制
- 在第一阶段和第二阶段中插入一个**准备**阶段, 保证提交阶段之前各参与节点的状态是一致的

## Paxos 算法

### 节点类型

- Proposer: 提案者

- Acceptor: 批准者

- Learner: 学习者

### 约束条件

- Acceptor 必须接受它接受到的第一个提案

- 如果一个提案的 Value 值被大多数 Acceptor 接受过, 那后续的所有被接受的提案中也必须包含 Value

- 如果某一轮 Paxos 协议批准了某个 Value, 则以后各轮 Paxos 只能批准这个 Value
