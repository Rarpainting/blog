# Nginx

Nginx 定义了一种基础类型的模块: 核心模块, 模块类型-NGX_CORE_MODULE, 目地是使非模块框架值关注于如何于 6 个核心模块通信

事件模块/HTTP 模块/mail 模块共性: 各有一个模块作为代言人, 并在同类模块中由 1 个作为核心业务于管理功能的模块

事件模块使 HTTP 模块和 mail 模块的基础

## Nginx 核心进程模型 

### Master 进程

- 监控进程 - 进程组与用户的交互接口, 同时对进程进行监控
- 不处理网络事件, 不负责业务的执行
- 管理 worker 进程来实现 **重启服务/平滑升级/更换日志文件/配置文件实时生效**
- master 的 `for(;;)` 中的 `sigsuspend()` 负责挂起进程, 直到进程接收到信号

### Worker 进程

- 处理基本的网络事件
- Worker 之间的进程是对等的, 只可能在相同的 Worker 中处理
- 更多的 Worker 数, 只会导致进程相互竞争 CPU 资源, 从而带来不必要的上下文切换, 因而 Worker 数一般与 CPU 数对等

### 处理过程

- 略

#### 惊群现象

当一个连接进来后, 所有的 `accept` 在这个 socket 上面的进程, *都会* 收到通知, 然而只有一个进程能处理(`accept`)该连接, 其他的则 `accept` 失败

Nginx 对惊群现象的处理:

一个 worker 进程在 accept 这个连接之后, 所有的 连接/解析/处理/数据产生/数据返回/断开连接 都在一个连接中解决

### Nginx 事件处理机制

- 异步非阻塞的事件处理机制

### Nginx 与 Apache

- Apache 每个请求都独占一个线程, 抗压不行, 在 PHP 处理慢或者前端压力大的情况下, 会出现 Apache 进程数飙升而导致拒绝服务
- Nginx 一个进程只有一个主线程, 通过异步非阻塞的事件处理机制, 实现循环处理
- Nginx 网络模式是事件驱动(select/poll/epoll)
- Nginx 做前端负责进行抗并发/反向代理、负载均衡、静态文件缓存, 后端采用 Apache 处理动态请求

